ca65 V2.19 - Git de30a57
Main file   : irq_main.s
Current file: irq_main.s

000000r 1               
000000r 1               	.export		IRQ_main
000000r 1               
000000r 1               	.include	"sample.inc"
000000r 2               
000000r 2               	.setcpu		"6502"
000000r 2               
000000r 2               	.include	"nes.inc"
000000r 3               ;
000000r 3               ; NES definitions
000000r 3               ;
000000r 3               
000000r 3               .ifndef	__NES_INC__
000000r 3               
000000r 3               .define	__NES_INC__
000000r 3               
000000r 3               ;; PPU defines
000000r 3               PPU_CTRL1	= $2000
000000r 3               PPU_CTRL2	= $2001
000000r 3               PPU_STATUS	= $2002
000000r 3               PPU_SPR_ADDR	= $2003
000000r 3               PPU_SPR_IO  	= $2004
000000r 3               PPU_VRAM_ADDR1	= $2005
000000r 3               PPU_VRAM_ADDR2	= $2006
000000r 3               PPU_VRAM_IO	= $2007
000000r 3               
000000r 3               ;; APU defines
000000r 3               APU_PULSE1CTRL  = $4000         ; Pulse #1 Control Register (W)
000000r 3               APU_PULSE1RAMP  = $4001         ; Pulse #1 Ramp Control Register (W)
000000r 3               APU_PULSE1FTUNE = $4002         ; Pulse #1 Fine Tune (FT) Register (W)
000000r 3               APU_PULSE1CTUNE = $4003         ; Pulse #1 Coarse Tune (CT) Register (W)
000000r 3               APU_PULSE2CTRL  = $4004         ; Pulse #2 Control Register (W)
000000r 3               APU_PULSE2RAMP  = $4005         ; Pulse #2 Ramp Control Register (W)
000000r 3               APU_PULSE2FTUNE = $4006         ; Pulse #2 Fine Tune Register (W)
000000r 3               APU_PULSE2STUNE = $4007         ; Pulse #2 Coarse Tune Register (W)
000000r 3               APU_TRICTRL1    = $4008         ; Triangle Control Register #1 (W)
000000r 3               APU_TRICTRL2    = $4009         ; Triangle Control Register #2 (?)
000000r 3               APU_TRIFREQ1    = $400A         ; Triangle Frequency Register #1 (W)
000000r 3               APU_TRIFREQ2    = $400B         ; Triangle Frequency Register #2 (W)
000000r 3               APU_NOISECTRL   = $400C         ; Noise Control Register #1 (W)
000000r 3               ;;APU_ = $400D  ; Unused (???)
000000r 3               APU_NOISEFREQ1  = $400E         ; Noise Frequency Register #1 (W)
000000r 3               APU_NOISEFREQ2  = $400F         ; Noise Frequency Register #2 (W)
000000r 3               APU_MODCTRL     = $4010         ; Delta Modulation Control Register (W)
000000r 3               APU_MODDA       = $4011         ; Delta Modulation D/A Register (W)
000000r 3               APU_MODADDR     = $4012         ; Delta Modulation Address Register (W)
000000r 3               APU_MODLEN      = $4013         ; Delta Modulation Data Length Register (W)
000000r 3               APU_SPR_DMA    	= $4014         ; Sprite DMA Register (W)
000000r 3               APU_CHANCTRL   	= $4015         ; Sound/Vertical Clock Signal Register (R)
000000r 3               APU_PAD1       	= $4016         ; Joypad #1 (RW)
000000r 3               APU_PAD2	= $4017         ; Joypad #2/SOFTCLK (RW)
000000r 3               
000000r 3               .endif
000000r 3               
000000r 2               
000000r 2               	.include	"nsd.inc"
000000r 3               ;===============================================================================|
000000r 3               ;										|
000000r 3               ;		NES Sound Driver & library	(NSD.lib)			|
000000r 3               ;										|
000000r 3               ;-------------------------------------------------------------------------------|
000000r 3               ;										|
000000r 3               ;  Copyright (c) 2012 A.Watanabe (S.W.)						|
000000r 3               ;  All rights reserved.								|
000000r 3               ;										|
000000r 3               ;  Redistribution and use in source and binary forms, with or without		|
000000r 3               ;  modification, are permitted provided that the following conditions		|
000000r 3               ;  are met:									|
000000r 3               ;										|
000000r 3               ;    1. Redistributions of source code must retain the above copyright		|
000000r 3               ;       notice, this list of conditions and the following disclaimer.		|
000000r 3               ;										|
000000r 3               ;    2. Redistributions in binary form must reproduce the above copyright	|
000000r 3               ;       notice, this list of conditions and the following disclaimer in the	|
000000r 3               ;       documentation and/or other materials provided with the distribution.	|
000000r 3               ;										|
000000r 3               ;  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS		|
000000r 3               ;  "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT		|
000000r 3               ;  LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR	|
000000r 3               ;  A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER	|
000000r 3               ;  OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,	|
000000r 3               ;  EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,		|
000000r 3               ;  PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR		|
000000r 3               ;  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF	|
000000r 3               ;  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING		|
000000r 3               ;  NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS		|
000000r 3               ;  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.			|
000000r 3               ;										|
000000r 3               ;===============================================================================|
000000r 3               
000000r 3               	.include	"nsddef.inc"
000000r 4               ;=======================================================================
000000r 4               ;
000000r 4               ;	NES Sound Driver & library (NSD.lib)	Define file
000000r 4               ;
000000r 4               ;-----------------------------------------------------------------------
000000r 4               ;
000000r 4               ;	Copyright (c) 2012 A.Watanabe (S.W.), All rights reserved.
000000r 4               ;	For conditions of distribution and use, see copyright notice
000000r 4               ;	  in "nsd.h" or "nsd.inc".
000000r 4               ;
000000r 4               ;=======================================================================
000000r 4               
000000r 4               
000000r 4               
000000r 4               ;****************************************************************
000000r 4               ;*	NTSC / PAL						*
000000r 4               ;****************************************************************
000000r 4               
000000r 4               .ifndef PAL
000000r 4               Tempo_Sub		= 150
000000r 4               .else
000000r 4               Tempo_Sub		= 125
000000r 4               .endif
000000r 4               
000000r 4               Tempo_Cmp		= 256 - Tempo_Sub
000000r 4               
000000r 4               ;****************************************************************
000000r 4               ;*	Sound I/O Device address defines			*
000000r 4               ;****************************************************************
000000r 4               
000000r 4               ;---------------------------------------
000000r 4               ;FDS define
000000r 4               
000000r 4               FDS_Control		= $4023
000000r 4               FDS_Wave_Table		= $4040		; to $407F
000000r 4               FDS_Volume		= $4080
000000r 4               FDS_FTUNE		= $4082
000000r 4               FDS_CTUNE		= $4083
000000r 4               FDS_Sweep_Envelope	= $4084
000000r 4               FDS_Sweep_Bias		= $4085
000000r 4               FDS_Mod_FTUNE		= $4086
000000r 4               FDS_Mod_CTUNE		= $4087
000000r 4               FDS_Mod_Append		= $4088
000000r 4               FDS_Write_Enable	= $4089
000000r 4               FDS_Envelope_Speed	= $408A
000000r 4               FDS_Volume_Gain		= $4090		;$4080's value
000000r 4               FDS_Sweep_Gain		= $4092		;$4084's value
000000r 4               
000000r 4               ;---------------------------------------
000000r 4               ;VRC6 define
000000r 4               
000000r 4               VRC6_Frequency		= $9003		;.... .ABH	Normally you should write $00 to this register on startup to initialize it.
000000r 4               VRC6_Pulse1_CTRL	= $9000		;MDDD vvvv	mode DT vol
000000r 4               VRC6_Pulse1_FTUNE	= $9001		;FFFF FFFF
000000r 4               VRC6_Pulse1_CTUNE	= $9002		;E... FFFF
000000r 4               VRC6_Pulse2_CTRL	= $A000
000000r 4               VRC6_Pulse2_FTUNE	= $A001
000000r 4               VRC6_Pulse2_CTUNE	= $A002
000000r 4               VRC6_SAW_CTRL		= $B000		;..AA AAAA	volume
000000r 4               VRC6_SAW_FTUNE		= $B001		;FFFF FFFF
000000r 4               VRC6_SAW_CTUNE		= $B002		;E... FFFF
000000r 4               
000000r 4               ;---------------------------------------
000000r 4               ;VRC7 define
000000r 4               
000000r 4               VRC7_Resister		= $9010		;wait  6 clk
000000r 4               VRC7_Data		= $9030		;wait 42 clk
000000r 4               
000000r 4               VRC7_Patch0		= $00
000000r 4               VRC7_Patch1		= $01
000000r 4               VRC7_Patch2		= $02
000000r 4               VRC7_Patch3		= $03
000000r 4               VRC7_Patch4		= $04
000000r 4               VRC7_Patch5		= $05
000000r 4               VRC7_Patch6		= $06
000000r 4               VRC7_Patch7		= $07
000000r 4               
000000r 4               VRC7_Frequency		= $10
000000r 4               VRC7_Octave		= $20
000000r 4               VRC7_Volume		= $30
000000r 4               
000000r 4               ;---------------------------------------
000000r 4               ;OPLL define
000000r 4               
000000r 4               .ifdef	HFX4
000000r 4               OPLL_Resister		= $5F90		;wait  6 clk
000000r 4               OPLL_Data		= $5FB0		;wait 42 clk
000000r 4               .else
000000r 4               OPLL_Resister		= $9010		;wait  6 clk
000000r 4               OPLL_Data		= $9030		;wait 42 clk
000000r 4               .endif
000000r 4               
000000r 4               OPLL_Patch0		= $00
000000r 4               OPLL_Patch1		= $01
000000r 4               OPLL_Patch2		= $02
000000r 4               OPLL_Patch3		= $03
000000r 4               OPLL_Patch4		= $04
000000r 4               OPLL_Patch5		= $05
000000r 4               OPLL_Patch6		= $06
000000r 4               OPLL_Patch7		= $07
000000r 4               
000000r 4               OPLL_RHYTHM		= $0E
000000r 4               OPLL_Frequency		= $10
000000r 4               OPLL_Octave		= $20
000000r 4               OPLL_Volume		= $30
000000r 4               
000000r 4               OPLL_Frequency_BD	= $16
000000r 4               OPLL_Frequency_HH_SD	= $17
000000r 4               OPLL_Frequency_TOM_CYM	= $18
000000r 4               
000000r 4               OPLL_Octave_BD		= $26
000000r 4               OPLL_Octave_HH_SD	= $27
000000r 4               OPLL_Octave_TOM_CYM	= $28
000000r 4               
000000r 4               OPLL_BD			= $36
000000r 4               OPLL_HH_SD		= $37
000000r 4               OPLL_TOM_CYM		= $38
000000r 4               
000000r 4               
000000r 4               ;---------------------------------------
000000r 4               ;MMC5 define
000000r 4               
000000r 4               MMC5_Pulse1_CTRL	= $5000         ; Pulse_ #1 Control Register (W)
000000r 4               MMC5_Pulse1_FTUNE	= $5002         ; Pulse_ #1 Fine Tune (FT) Register (W)
000000r 4               MMC5_Pulse1_CTUNE	= $5003         ; Pulse_ #1 Coarse Tune (CT) Register (W)
000000r 4               MMC5_Pulse2_CTRL	= $5004         ; Pulse_ #2 Control Register (W)
000000r 4               MMC5_Pulse2_FTUNE	= $5006         ; Pulse_ #2 Fine Tune Register (W)
000000r 4               MMC5_Pulse2_CTUNE	= $5007         ; Pulse_ #2 Coarse Tune Register (W)
000000r 4               MMC5_CHANCTRL		= $5015         ;
000000r 4               
000000r 4               ;---------------------------------------
000000r 4               ;N163 define
000000r 4               
000000r 4               N163_Resister		= $F800
000000r 4               N163_Data		= $4800
000000r 4               
000000r 4               N163_Frequency_Low	= $78
000000r 4               N163_Frequency_Middle	= $7A
000000r 4               N163_Frequency_High	= $7C
000000r 4               N163_Waveform		= $7E
000000r 4               N163_Volume		= $7F
000000r 4               
000000r 4               ;---------------------------------------
000000r 4               ;PSG define
000000r 4               
000000r 4               .ifdef	HFE4
000000r 4               PSG_Register		= $5FE0
000000r 4               PSG_Data		= $5FE1
000000r 4               .else
000000r 4               PSG_Register		= $C000
000000r 4               PSG_Data		= $E000
000000r 4               .endif
000000r 4               
000000r 4               PSG_1_Frequency_Low	= $00
000000r 4               PSG_1_Frequency_High	= $01
000000r 4               PSG_2_Frequency_Low	= $02
000000r 4               PSG_2_Frequency_High	= $03
000000r 4               PSG_3_Frequency_Low	= $04
000000r 4               PSG_3_Frequency_High	= $05
000000r 4               PSG_Noise_Frequency	= $06
000000r 4               PSG_Switch		= $07	;00ABCabc
000000r 4               PSG_1_Volume		= $08
000000r 4               PSG_2_Volume		= $09
000000r 4               PSG_3_Volume		= $0A
000000r 4               PSG_Envelope_Low	= $0B
000000r 4               PSG_Envelope_High	= $0C
000000r 4               PSG_Envelope_Form	= $0D
000000r 4               
000000r 4               
000000r 4               
000000r 4               
000000r 4               
000000r 4               ;****************************************************************
000000r 4               ;*	NSD.lib General Define					*
000000r 4               ;****************************************************************
000000r 4               
000000r 4               .scope	nsd
000000r 4               	APU_Track	= 5			;
000000r 4               
000000r 4               	TR_FDS		= APU_Track * 2
000000r 4               	.ifdef	FDS
000000r 4               		FDS_Track	= 1		;
000000r 4               	.else
000000r 4               		FDS_Track	= 0		;
000000r 4               	.endif
000000r 4               
000000r 4               	TR_VRC6		= TR_FDS + FDS_Track * 2
000000r 4               	.ifdef	VRC6
000000r 4               		VRC6_Track	= 3		;
000000r 4               	.else
000000r 4               		VRC6_Track	= 0		;
000000r 4               	.endif
000000r 4               
000000r 4               	TR_VRC7		= TR_VRC6 + VRC6_Track * 2
000000r 4               	.ifdef	VRC7
000000r 4               		VRC7_Track	= 6		;
000000r 4               	.else
000000r 4               		VRC7_Track	= 0		;
000000r 4               	.endif
000000r 4               
000000r 4               	TR_OPLL		= TR_VRC7 + VRC7_Track * 2
000000r 4               	.ifdef	OPLL
000000r 4               		OPLL_Track_FM		= 9
000000r 4               		OPLL_Track_Rhythm	= 5
000000r 4               		OPLL_Track	= OPLL_Track_FM + OPLL_Track_Rhythm
000000r 4               	.else
000000r 4               		OPLL_Track	= 0		;
000000r 4               	.endif
000000r 4               
000000r 4               	TR_MMC5		= TR_OPLL + OPLL_Track * 2
000000r 4               	.ifdef	MMC5
000000r 4               		MMC5_Track	= 2		; (without DPCM)
000000r 4               	.else
000000r 4               		MMC5_Track	= 0		;
000000r 4               	.endif
000000r 4               
000000r 4               	TR_N163		= TR_MMC5 + MMC5_Track * 2
000000r 4               	.ifdef	N163
000000r 4               		N163_Track	= 8		;
000000r 4               	.else
000000r 4               		N163_Track	= 0		;
000000r 4               	.endif
000000r 4               
000000r 4               	TR_PSG		= TR_N163 + N163_Track * 2
000000r 4               	.ifdef	PSG
000000r 4               		PSG_Track	= 3		;
000000r 4               	.else
000000r 4               		PSG_Track	= 0		;
000000r 4               	.endif
000000r 4               
000000r 4               	TR_NULL		= TR_PSG + PSG_Track * 2
000000r 4               	.ifdef	NULL
000000r 4               		NULL_Track	= 1		;
000000r 4               	.else
000000r 4               		NULL_Track	= 0		;
000000r 4               	.endif
000000r 4               
000000r 4               	BGM_Track	= APU_Track + FDS_Track + VRC6_Track + VRC7_Track + OPLL_Track + MMC5_Track + N163_Track + PSG_Track + NULL_Track
000000r 4               	.ifdef	SE
000000r 4               	  SE_Track	= 5		;
000000r 4               	.else
000000r 4               	  SE_Track	= 2		;
000000r 4               	.endif
000000r 4               
000000r 4               	Track		= BGM_Track + SE_Track
000000r 4               
000000r 4               	TR_BGM1		= 0
000000r 4               	TR_BGM2		= 2
000000r 4               	TR_BGM3		= 4
000000r 4               	TR_BGM4		= 6
000000r 4               	TR_BGM5		= 8
000000r 4               	TR_SE		= BGM_Track * 2
000000r 4               	.ifdef	SE
000000r 4               	TR_SE_Pluse1	= TR_SE + 0
000000r 4               	TR_SE_Pluse2	= TR_SE + 2
000000r 4               	TR_SE_Tri	= TR_SE + 4
000000r 4               	TR_SE_Noise	= TR_SE + 6
000000r 4               	TR_SE_Dpcm	= TR_SE + 8
000000r 4               	.else
000000r 4               	TR_SE_Pluse2	= TR_SE + 0
000000r 4               	TR_SE_Noise	= TR_SE + 2
000000r 4               	.endif
000000r 4               
000000r 4               .endscope
000000r 4               
000000r 4               
000000r 4               
000000r 4               
000000r 4               
000000r 4               ;****************************************************************
000000r 4               ;*	Struct Define						*
000000r 4               ;****************************************************************
000000r 4               
000000r 4               ;=======================================================================
000000r 4               ;	Working Struct define in Zero-page area
000000r 4               ;-----------------------------------------------------------------------
000000r 4               
000000r 4               .Struct		NSD_Envelop
000000r 4               	V		.byte		;Volume & Voice (ch3:Tempo / ch5:Tempo_ctr)
000000r 4               	F		.byte		;Frequency & Note
000000r 4               .Endstruct
000000r 4               
000000r 4               .Struct		NSD_Length_Cnt
000000r 4               	counter		.byte		;now length of note
000000r 4               	gate		.byte		;length - u
000000r 4               .Endstruct
000000r 4               
000000r 4               .Struct		NSD_work_zp
000000r 4               	_ptr		.word					;00 General pointer value
000000r 4               	_tmp		.word					;02 General value
000000r 4               	channel		.byte					;04 channel (x resister)
000000r 4               	flag		.byte					;05 flag
000000r 4               	Sequence_ptr	.word			nsd::Track	;06 Address of playing sequence
000000r 4               .ifndef	HFX4
000000r 4               	LengthCnt	.tag	NSD_Length_Cnt	nsd::Track	;16 Length Counter
000000r 4               .endif
000000r 4               	Envelop		.tag	NSD_Envelop	nsd::Track	;26 Envelop counter
000000r 4               .Endstruct
000000r 4               
000000r 4               ; 6 + ( 6 [Byte] * 28 [ch] ) = 174
000000r 4               
000000r 4               ;---------------------------------------
000000r 4               ;	Defines for work structures
000000r 4               
000000r 4               .scope	nsd_flag
000000r 4               	BGM		= $01	;Playing BGM
000000r 4               	SE		= $02	;Playing SE
000000r 4               	Jump		= $10	;
000000r 4               	Priority	= $0C	;Priority of now SE
000000r 4               	Disable		= $80	;Disable of sound driver
000000r 4               .endscope
000000r 4               
000000r 4               ;Zero Page Works
000000r 4               .define	__ptr		nsd_work_zp + NSD_work_zp::_ptr
000000r 4               .define	__tmp		nsd_work_zp + NSD_work_zp::_tmp
000000r 4               .define	__flag		nsd_work_zp + NSD_work_zp::flag
000000r 4               .define	__channel	nsd_work_zp + NSD_work_zp::channel
000000r 4               .define	__Sequence_ptr	nsd_work_zp + NSD_work_zp::Sequence_ptr
000000r 4               
000000r 4               .define	__Envelop_V	nsd_work_zp + NSD_work_zp::Envelop + NSD_Envelop::V	;upper 4bit Voice / lower 4bit:Volume
000000r 4               .define	__Envelop_F	nsd_work_zp + NSD_work_zp::Envelop + NSD_Envelop::F	;upper 4bit:Note  / lower 4bit:Frequency
000000r 4               
000000r 4               ;.define	__flag		nsd_work_zp + NSD_work_zp::Envelop + NSD_Envelop::V + nsd::TR_BGM3
000000r 4               .define	__Tempo		nsd_work_zp + NSD_work_zp::Envelop + NSD_Envelop::F + nsd::TR_BGM5
000000r 4               .define	__Tempo_ctr	nsd_work_zp + NSD_work_zp::Envelop + NSD_Envelop::V + nsd::TR_BGM5
000000r 4               
000000r 4               
000000r 4               
000000r 4               
000000r 4               
000000r 4               ;=======================================================================
000000r 4               ;	Working  Struct define in RAM area
000000r 4               ;-----------------------------------------------------------------------
000000r 4               
000000r 4               .Struct		NSD_Flag
000000r 4               	flag		.byte		;flag
000000r 4               	gatemode	.byte		;gate mode
000000r 4               .Endstruct
000000r 4               
000000r 4               .Struct		NSD_length
000000r 4               	length		.byte		;`l' command value
000000r 4               	tai		.byte		;flag of Tai & Slur
000000r 4               .Endstruct
000000r 4               
000000r 4               .Struct		NSD_gatetime
000000r 4               	q		.byte		;`q' command value
000000r 4               	u		.byte		;`u' command value
000000r 4               .Endstruct
000000r 4               
000000r 4               .Struct		NSD_note
000000r 4               	note		.byte		;`note' command value (bit 7 = `H' : rest)
000000r 4               	octave		.byte		;`o' command value
000000r 4               .Endstruct
000000r 4               
000000r 4               .Struct		NSD_Detune
000000r 4               	cent		.byte		;`D' command value
000000r 4               	fine		.byte		;`D%' command value
000000r 4               .Endstruct
000000r 4               
000000r 4               .Struct		NSD_Por_Lv		;(ch5 : BGM1 & BGM2 Frequency)
000000r 4               	target		.byte		;`P' target
000000r 4               	depth		.byte		;`P' add value
000000r 4               .Endstruct
000000r 4               
000000r 4               .Struct		NSD_Por_Co		;(ch5 : BGM3 & SE  Frequency)
000000r 4               	count		.byte		;rate control
000000r 4               	rate		.byte		;now depth
000000r 4               .Endstruct
000000r 4               
000000r 4               .Struct		NSD_Trans
000000r 4               	trans		.byte		;`_' command value
000000r 4               	onetime		.byte		;`'', `"' command value
000000r 4               .Endstruct
000000r 4               
000000r 4               .Struct		NSD_Repeat
000000r 4               	count1		.byte		;counter of repeat(A)
000000r 4               	count2		.byte		;counter of repeat(B)
000000r 4               .Endstruct
000000r 4               
000000r 4               .Struct		NSD_volume
000000r 4               	volume		.byte		;`v' & `vR' command value
000000r 4               	volume_env	.byte		;now envelop volume	(ch3,5 : sweep value of ch1,2)
000000r 4               .Endstruct
000000r 4               
000000r 4               ;.Struct		NSD_voice
000000r 4               ;	voice		.byte		;`@R' command value (upper 4bit)	;※廃止
000000r 4               ;	voice_set	.byte		;deveice setting value
000000r 4               ;.Endstruct
000000r 4               
000000r 4               .Struct		NSD_Env_V_Ptr		;(ch5 : pointer of ⊿PCM information)
000000r 4               	Volume		.byte		;Volume
000000r 4               	Voice		.byte		;Voice
000000r 4               .Endstruct
000000r 4               
000000r 4               .Struct		NSD_Env_F_Ptr
000000r 4               	Frequency	.byte		;Freeuqncy
000000r 4               	Note		.byte		;Note
000000r 4               .Endstruct
000000r 4               
000000r 4               .Struct		NSD_Env_F_Now
000000r 4               	Frequency	.byte		;now envelop Freeuqncy
000000r 4               	Note		.byte		;now envelop Note
000000r 4               .Endstruct
000000r 4               
000000r 4               .Struct		NSD_work
000000r 4               	Flag		.tag	NSD_Flag	nsd::Track	;flag
000000r 4               .ifdef	HFX4
000000r 4               	LengthCnt	.tag	NSD_Length_Cnt	nsd::Track	;16 Length Counter
000000r 4               .endif
000000r 4               	Length		.tag	NSD_length	nsd::Track	;note length [tick]
000000r 4               	Gatetime	.tag	NSD_gatetime	nsd::Track	;gate time [tick]
000000r 4               	Note		.tag	NSD_note	nsd::Track	;octave and note command
000000r 4               	Detune		.tag	NSD_Detune	nsd::Track	;detune
000000r 4               	Por_Lv		.tag	NSD_Por_Lv	nsd::Track	;Portamento / TR5: BGM1 & BGM2 frequency
000000r 4               	Por_Co		.tag	NSD_Por_Co	nsd::Track	;Portamento / TR5: BGM3 & SE1  frequency
000000r 4               	Por_now		.word			nsd::Track	;Portamento / TR5: SE2  & SE3  frequency
000000r 4               	Trans		.tag	NSD_Trans	nsd::Track	;Transpose
000000r 4               	Repeat		.tag	NSD_Repeat	nsd::Track	;Repeat
000000r 4               	Volume		.tag	NSD_volume	nsd::Track	;volume	/ TR3: BGM1 sweep / TR5: BGM2 sweep
000000r 4               	Env_F_Now	.tag	NSD_Env_F_Now	nsd::Track	;Now value of envelop
000000r 4               	Env_V_Ptr	.tag	NSD_Env_V_Ptr	nsd::Track	;Address of envelop / TR5:DPCM info
000000r 4               	Env_F_Ptr	.tag	NSD_Env_F_Ptr	nsd::Track	;Address of envelop
000000r 4               	Envelop_Volume	.word			nsd::Track	;Pointer of envelop
000000r 4               	Envelop_Voice	.word			nsd::Track	;Pointer of envelop
000000r 4               	Envelop_Freq	.word			nsd::Track	;Pointer of envelop
000000r 4               	Envelop_Note	.word			nsd::Track	;Pointer of envelop
000000r 4               	Frequency	.word			nsd::Track	;Setting frequency
000000r 4               	SubRoutine	.word			nsd::Track	;Pointer of sub-routine return address
000000r 4               	Repeat2		.word			nsd::Track	;Pointer of repeat2 goto point
000000r 4               
000000r 4               ;.ifdef	MMC5
000000r 4               ;	MMC5_Frequency	.byte			nsd::MMC5_Track	;MMC5 frequency
000000r 4               ;.endif
000000r 4               
000000r 4               .ifdef	FDS
000000r 4               	FDS_Frequency	.byte					;FDS frequency
000000r 4               	FDS_SweepBias	.byte					;FDS Sweep bias
000000r 4               .endif
000000r 4               
000000r 4               .ifdef	MMC5
000000r 4               	MMC5_VoiceSet	.byte			nsd::MMC5_Track
000000r 4               	MMC5_Frequency	.byte			nsd::MMC5_Track	;MMC5 frequecny
000000r 4               .endif
000000r 4               
000000r 4               .ifdef	VRC7
000000r 4               	VRC7_VoiceSet	.byte			nsd::VRC7_Track
000000r 4               	VRC7_Freq_old	.byte			nsd::VRC7_Track
000000r 4               	VRC7_Frequency	.word			nsd::VRC7_Track	;VRC7 frequecny
000000r 4               	VRC7_Reg	.word					;
000000r 4               .endif
000000r 4               
000000r 4               .ifdef	OPLL
000000r 4               	OPLL_VoiceSet	.byte			nsd::OPLL_Track_FM
000000r 4               	OPLL_Freq_old	.byte			nsd::OPLL_Track_FM
000000r 4               	OPLL_Frequency	.word			nsd::OPLL_Track_FM	;OPLL frequency (FM)
000000r 4               	OPLL_Reg	.word
000000r 4               	OPLL_Rhythm	.byte						;OPLL Rhythm
000000r 4               .endif
000000r 4               
000000r 4               .ifdef	N163
000000r 4               	N163_num	.byte					;N163 ch number
000000r 4               	N163_Frequency	.byte			nsd::N163_Track	;N163 frequency
000000r 4               .endif
000000r 4               
000000r 4               .ifdef	PSG
000000r 4               	PSG_switch	.byte					;PSG switch
000000r 4               .endif
000000r 4               
000000r 4               .Endstruct
000000r 4               
000000r 4               
000000r 4               
000000r 4               ;---------------------------------------
000000r 4               ;	Defines for work structures
000000r 4               
000000r 4               .scope	nsd_chflag
000000r 4               .ifdef	MASK
000000r 4               	Mask	= $80
000000r 4               .endif
000000r 4               	Sustain	= $20		;for VRC7
000000r 4               	KeyOn	= $10		;for VRC7
000000r 4               	Envelop	= $10		;for PSG
000000r 4               	FDSVOL	= $0C
000000r 4               	NoKeyOff= $04		;for VRC7
000000r 4               	KeyOff	= $03		;00	Key Off	: Vol = 0
000000r 4               				;01	Key Off	: Release command
000000r 4               				;10	Key Off	:  envelop
000000r 4               				;11	Note On	: (envelop)
000000r 4               .endscope
000000r 4               
000000r 4               .scope	nsd_mode
000000r 4               	voiceR		= $F0	;1111 0000	Release Volume
000000r 4               	voice		= $08	;0000 1000
000000r 4               	RetSE		= $04	;0000 0100	Key On (Ch.3)
000000r 4               	gatemode	= $03	;0000 0011	Gate mode
000000r 4               .endscope
000000r 4               
000000r 4               
000000r 4               ;RAM Works
000000r 4               .ifdef	HFX4
000000r 4               .define	__Length_ctr	nsd_work + NSD_work::LengthCnt + NSD_Length_Cnt::counter
000000r 4               .define	__Gate		nsd_work + NSD_work::LengthCnt + NSD_Length_Cnt::gate
000000r 4               .else
000000r 4               .define	__Length_ctr	nsd_work_zp + NSD_work_zp::LengthCnt + NSD_Length_Cnt::counter
000000r 4               .define	__Gate		nsd_work_zp + NSD_work_zp::LengthCnt + NSD_Length_Cnt::gate
000000r 4               .endif
000000r 4               
000000r 4               .define	__chflag	nsd_work + NSD_work::Flag + NSD_Flag::flag
000000r 4               .define	__gatemode	nsd_work + NSD_work::Flag + NSD_Flag::gatemode
000000r 4               .define	__tai		nsd_work + NSD_work::Length + NSD_length::tai
000000r 4               .define	__length	nsd_work + NSD_work::Length + NSD_length::length
000000r 4               .define	__gate_q	nsd_work + NSD_work::Gatetime + NSD_gatetime::q
000000r 4               .define	__gate_u	nsd_work + NSD_work::Gatetime + NSD_gatetime::u
000000r 4               .define __note		nsd_work + NSD_work::Note + NSD_note::note
000000r 4               .define	__octave	nsd_work + NSD_work::Note + NSD_note::octave
000000r 4               .define	__detune_cent	nsd_work + NSD_work::Detune + NSD_Detune::cent
000000r 4               .define	__detune_fine	nsd_work + NSD_work::Detune + NSD_Detune::fine
000000r 4               .define	__por_target	nsd_work + NSD_work::Por_Lv + NSD_Por_Lv::target
000000r 4               .define	__por_depth	nsd_work + NSD_work::Por_Lv + NSD_Por_Lv::depth
000000r 4               .define	__por_ctr	nsd_work + NSD_work::Por_Co + NSD_Por_Co::count
000000r 4               .define	__por_rate	nsd_work + NSD_work::Por_Co + NSD_Por_Co::rate
000000r 4               .define __por_now	nsd_work + NSD_work::Por_now
000000r 4               .define	__trans		nsd_work + NSD_work::Trans + NSD_Trans::trans
000000r 4               .define	__trans_one	nsd_work + NSD_work::Trans + NSD_Trans::onetime
000000r 4               .define	__repeat_ctr	nsd_work + NSD_work::Repeat + NSD_Repeat::count1
000000r 4               .define	__repeat_ctr2	nsd_work + NSD_work::Repeat + NSD_Repeat::count2
000000r 4               .define	__volume	nsd_work + NSD_work::Volume + NSD_volume::volume
000000r 4               .define	__frequency	nsd_work + NSD_work::Frequency
000000r 4               .define	__subroutine	nsd_work + NSD_work::SubRoutine
000000r 4               .define	__repeat2	nsd_work + NSD_work::Repeat2
000000r 4               .define	__env_volume	nsd_work + NSD_work::Envelop_Volume
000000r 4               .define	__env_voice	nsd_work + NSD_work::Envelop_Voice
000000r 4               .define	__env_frequency	nsd_work + NSD_work::Envelop_Freq
000000r 4               .define	__env_note	nsd_work + NSD_work::Envelop_Note
000000r 4               .define	__env_vol_ptr	nsd_work + NSD_work::Env_V_Ptr + NSD_Env_V_Ptr::Volume
000000r 4               .define	__env_voi_ptr	nsd_work + NSD_work::Env_V_Ptr + NSD_Env_V_Ptr::Voice
000000r 4               .define	__env_freq_ptr	nsd_work + NSD_work::Env_F_Ptr + NSD_Env_F_Ptr::Frequency
000000r 4               .define	__env_note_ptr	nsd_work + NSD_work::Env_F_Ptr + NSD_Env_F_Ptr::Note
000000r 4               ;	voiceに関しては、その後の演算は無いので、更新されない場合はエンベロープ処理を終了する。
000000r 4               .define	__env_vol_now	nsd_work + NSD_work::Volume + NSD_volume::volume_env
000000r 4               .define	__env_freq_now	nsd_work + NSD_work::Env_F_Now + NSD_Env_F_Now::Frequency
000000r 4               .define	__env_note_now	nsd_work + NSD_work::Env_F_Now + NSD_Env_F_Now::Note
000000r 4               
000000r 4               ;---------------
000000r 4               ;⊿PCM
000000r 4               .define	__dpcm_info		nsd_work + NSD_work::Env_V_Ptr + nsd::TR_BGM5		;.word
000000r 4               
000000r 4               ;Sweep
000000r 4               .define	__sweep_ch1		nsd_work + NSD_work::Envelop_Voice  + nsd::TR_BGM3
000000r 4               .define	__sweep_ch2		nsd_work + NSD_work::Envelop_Voice  + nsd::TR_BGM3 + 1
000000r 4               ;.define	__sweep_ch1		nsd_work + NSD_work::Volume + NSD_volume::volume     + nsd::TR_BGM5
000000r 4               ;.define	__sweep_ch2		nsd_work + NSD_work::Volume + NSD_volume::volume_env + nsd::TR_BGM5
000000r 4               
000000r 4               
000000r 4               ;Voice
000000r 4               ;.define	__apu_tri_time		nsd_work + NSD_work::Envelop_Voice  + nsd::TR_BGM5
000000r 4               ;.define	__apu_voice_set4	nsd_work + NSD_work::Envelop_Voice  + nsd::TR_BGM5 + 1
000000r 4               ;.define	__se_voice_set1		nsd_work + NSD_work::Env_F_Ptr + NSD_Env_F_Ptr::Frequency  + nsd::TR_BGM5
000000r 4               ;.define	__se_voice_set2		nsd_work + NSD_work::Env_F_Ptr + NSD_Env_F_Ptr::Note       + nsd::TR_BGM5
000000r 4               .define	__apu_voice_set1	nsd_work + NSD_work::Envelop_Volume + nsd::TR_BGM5
000000r 4               .define	__apu_voice_set2	nsd_work + NSD_work::Envelop_Volume + nsd::TR_BGM5 + 1
000000r 4               .define	__apu_tri_time		nsd_work + NSD_work::Envelop_Freq   + nsd::TR_BGM5
000000r 4               .define	__apu_voice_set4	nsd_work + NSD_work::Envelop_Freq   + nsd::TR_BGM5 + 1
000000r 4               
000000r 4               .ifdef	SE
000000r 4               .define	__se_voice_set1		nsd_work + NSD_work::Frequency      + nsd::TR_BGM5
000000r 4               .endif
000000r 4               .define	__se_voice_set2		nsd_work + NSD_work::Frequency      + nsd::TR_BGM5 + 1
000000r 4               .ifdef	SE
000000r 4               .define	__se_tri_time		nsd_work + NSD_work::Envelop_Voice  + nsd::TR_BGM5
000000r 4               .endif
000000r 4               .define	__se_voice_set4		nsd_work + NSD_work::Envelop_Voice  + nsd::TR_BGM5 + 1
000000r 4               
000000r 4               ;Frequency	（プチノイズ防止）
000000r 4               .define	__apu_frequency1	nsd_work + NSD_work::Por_Lv    + nsd::TR_BGM5		;.byte
000000r 4               .define	__apu_frequency2	nsd_work + NSD_work::Por_Lv    + nsd::TR_BGM5 + 1	;.byte
000000r 4               .define	__apu_frequency3	nsd_work + NSD_work::Por_Co    + nsd::TR_BGM5		;.byte
000000r 4               .ifdef	SE
000000r 4               .define	__se_frequency1		nsd_work + NSD_work::Por_Co    + nsd::TR_BGM5 + 1	;.byte
000000r 4               .endif
000000r 4               .define	__se_frequency2		nsd_work + NSD_work::Por_now   + nsd::TR_BGM5		;.byte
000000r 4               .ifdef	SE
000000r 4               .define	__se_frequency3		nsd_work + NSD_work::Por_now   + nsd::TR_BGM5 + 1	;.byte
000000r 4               .endif
000000r 4               
000000r 4               .ifdef	FDS
000000r 4               .define	__fds_frequency		nsd_work + NSD_work::FDS_Frequency
000000r 4               .define	__fds_sweepbias		nsd_work + NSD_work::FDS_SweepBias
000000r 4               .endif
000000r 4               
000000r 4               .ifdef	MMC5
000000r 4               ;.define	__mmc5_voice_set1	nsd_work + NSD_work::Envelop_Freq   + nsd::TR_BGM5	;.byte
000000r 4               ;.define	__mmc5_voice_set2	nsd_work + NSD_work::Envelop_Freq   + nsd::TR_BGM5 + 1	;.byte
000000r 4               .define	__mmc5_voice_set1	nsd_work + NSD_work::MMC5_VoiceSet
000000r 4               .define	__mmc5_voice_set2	nsd_work + NSD_work::MMC5_VoiceSet + 1
000000r 4               .define	__mmc5_frequency1	nsd_work + NSD_work::MMC5_Frequency
000000r 4               .define	__mmc5_frequency2	nsd_work + NSD_work::MMC5_Frequency + 1
000000r 4               .endif
000000r 4               
000000r 4               .ifdef	VRC6
000000r 4               .define	__vrc6_voice_set1	nsd_work + NSD_work::Envelop_Note   + nsd::TR_BGM5	;.byte
000000r 4               .define	__vrc6_voice_set2	nsd_work + NSD_work::Envelop_Note   + nsd::TR_BGM5 + 1	;.byte
000000r 4               .endif
000000r 4               
000000r 4               .ifdef	VRC7
000000r 4               .define	__vrc7_voice_set	nsd_work + NSD_work::VRC7_VoiceSet
000000r 4               .define	__vrc7_frequency	nsd_work + NSD_work::VRC7_Frequency
000000r 4               .define	__vrc7_freq_old		nsd_work + NSD_work::VRC7_Freq_old
000000r 4               .define	__vrc7_reg		nsd_work + NSD_work::VRC7_Reg
000000r 4               .endif
000000r 4               
000000r 4               .ifdef	OPLL
000000r 4               .define	__opll_voice_set	nsd_work + NSD_work::OPLL_VoiceSet
000000r 4               .define	__opll_frequency	nsd_work + NSD_work::OPLL_Frequency
000000r 4               .define	__opll_freq_old		nsd_work + NSD_work::OPLL_Freq_old
000000r 4               .define	__opll_reg		nsd_work + NSD_work::OPLL_Reg
000000r 4               .define	__opll_ryhthm		nsd_work + NSD_work::OPLL_Rhythm
000000r 4               .endif
000000r 4               
000000r 4               .ifdef	N163
000000r 4               .define	__n163_num		nsd_work + NSD_work::N163_num
000000r 4               .define	__n163_frequency	nsd_work + NSD_work::N163_Frequency
000000r 4               .endif
000000r 4               
000000r 4               .ifdef	PSG
000000r 4               .define	__psg_switch		nsd_work + NSD_work::PSG_switch
000000r 4               .endif
000000r 4               
000000r 4               
000000r 4               
000000r 4               
000000r 4               
000000r 4               ;=======================================================================
000000r 4               ;		Struct of DPCM
000000r 4               ;-----------------------------------------------------------------------
000000r 4               .Struct		nsd_dpcm
000000r 4               	Control		.byte		;I/O 0x4010
000000r 4               	DA		.byte		;I/O 0x4011
000000r 4               	Address		.byte		;I/O 0x4012
000000r 4               	Size		.byte		;I/O 0x4013
000000r 4               .ifdef	DPCMBank
000000r 4               	Bank		.byte		;Bank number
000000r 4               	Next		.byte		;Next number(note)
000000r 4               .endif
000000r 4               .Endstruct
000000r 4               
000000r 4               
000000r 4               
000000r 4               
000000r 4               
000000r 4               ;****************************************************************
000000r 4               ;*	Macros							*
000000r 4               ;****************************************************************
000000r 4               
000000r 4               ;=======================================================================
000000r 4               ;	void	NSD_MAIN_BGM()
000000r 4               ;-----------------------------------------------------------------------
000000r 4               ;<<Contents>>
000000r 4               ;	BGM main routine
000000r 4               ;<<Input>>
000000r 4               ;	none
000000r 4               ;<<Output>>
000000r 4               ;	none
000000r 4               ;=======================================================================
000000r 4               .macro	NSD_MAIN_BGM
000000r 4               	.local	BGM_Begin
000000r 4               	.local	BGM_SEQ_Exit
000000r 4               	.local	BGM_Exit
000000r 4               
000000r 4               	lda	#nsd_flag::BGM
000000r 4               	bit	__flag
000000r 4               	jne	BGM_Exit		;BGM disable ?
000000r 4               
000000r 4               	;-------------------------------
000000r 4               	;Tempo
000000r 4               	lda	__Tempo_ctr
000000r 4               	add	__Tempo
000000r 4               	sta	__Tempo_ctr
000000r 4               	jcc	BGM_SEQ_Exit
000000r 4               
000000r 4               	;-------------------------------
000000r 4               	;BGM
000000r 4               BGM_Begin:
000000r 4               	.repeat	nsd::BGM_Track, I
000000r 4               		ldx	#I*2 + nsd::TR_BGM1
000000r 4               		jsr	nsd_sequence
000000r 4               	.endrepeat
000000r 4               
000000r 4               	lda	#nsd_flag::Jump
000000r 4               	bit	__flag
000000r 4               	jne	BGM_Begin
000000r 4               
000000r 4               	lda	__Tempo_ctr
000000r 4               	sub	#Tempo_Sub
000000r 4               	sta	__Tempo_ctr
000000r 4               	cmp	#Tempo_Cmp
000000r 4               	jcc	BGM_Begin
000000r 4               
000000r 4               BGM_SEQ_Exit:
000000r 4               
000000r 4               	;-------
000000r 4               	;Envelop
000000r 4               	.repeat	nsd::BGM_Track, I
000000r 4               	  ;No envelope: DPCM, NULL
000000r 4               	  .if	(I <> 4) && (!(.defined(NULL) && (I = (nsd::TR_NULL / 2))))
000000r 4               		ldx	#I*2 + nsd::TR_BGM1
000000r 4               		jsr	nsd_envelop
000000r 4               	  .endif
000000r 4               	.endrepeat
000000r 4               
000000r 4               BGM_Exit:
000000r 4               
000000r 4               .endmacro
000000r 4               
000000r 4               ;=======================================================================
000000r 4               ;	void	NSD_MAIN_SE()
000000r 4               ;-----------------------------------------------------------------------
000000r 4               ;<<Contents>>
000000r 4               ;	SE main routine
000000r 4               ;<<Input>>
000000r 4               ;	none
000000r 4               ;<<Output>>
000000r 4               ;	none
000000r 4               ;=======================================================================
000000r 4               .macro	NSD_MAIN_SE
000000r 4               	.local	SE1
000000r 4               	.local	SE2
000000r 4               	.local	SE3
000000r 4               	.local	SE4
000000r 4               	.local	SE5
000000r 4               	.local	SE_Exit
000000r 4               
000000r 4               	lda	#nsd_flag::SE
000000r 4               	bit	__flag
000000r 4               	bne	SE_Exit			;SE disable ?
000000r 4               
000000r 4               ;---------------------------------------
000000r 4               .ifdef	SE
000000r 4               SE1:
000000r 4               	ldx	#nsd::TR_SE_Pluse1
000000r 4               	lda	__Sequence_ptr + 1,x
000000r 4               .ifdef	DPCMBank
000000r 4               	ora	__Sequence_ptr,x
000000r 4               .endif
000000r 4               	beq	@L
000000r 4               	jsr	nsd_sequence
000000r 4               	jsr	nsd_envelop
000000r 4               @L:
000000r 4               .endif
000000r 4               
000000r 4               ;---------------------------------------
000000r 4               SE2:
000000r 4               	ldx	#nsd::TR_SE_Pluse2
000000r 4               	lda	__Sequence_ptr + 1,x
000000r 4               .ifdef	DPCMBank
000000r 4               	ora	__Sequence_ptr,x
000000r 4               .endif
000000r 4               	beq	@L
000000r 4               	jsr	nsd_sequence
000000r 4               	jsr	nsd_envelop
000000r 4               @L:
000000r 4               
000000r 4               ;---------------------------------------
000000r 4               .ifdef	SE
000000r 4               SE3:
000000r 4               	ldx	#nsd::TR_SE_Tri
000000r 4               	lda	__Sequence_ptr + 1,x
000000r 4               .ifdef	DPCMBank
000000r 4               	ora	__Sequence_ptr,x
000000r 4               .endif
000000r 4               	beq	@L
000000r 4               	jsr	nsd_sequence
000000r 4               	jsr	nsd_envelop
000000r 4               @L:
000000r 4               .endif
000000r 4               
000000r 4               ;---------------------------------------
000000r 4               SE4:
000000r 4               	ldx	#nsd::TR_SE_Noise
000000r 4               	lda	__Sequence_ptr + 1,x
000000r 4               .ifdef	DPCMBank
000000r 4               	ora	__Sequence_ptr,x
000000r 4               .endif
000000r 4               	beq	@L
000000r 4               	jsr	nsd_sequence
000000r 4               	jsr	nsd_envelop
000000r 4               @L:
000000r 4               
000000r 4               ;---------------------------------------
000000r 4               .ifdef	SE
000000r 4               SE5:
000000r 4               	ldx	#nsd::TR_SE_Dpcm
000000r 4               	lda	__Sequence_ptr + 1,x
000000r 4               .ifdef	DPCMBank
000000r 4               	ora	__Sequence_ptr,x
000000r 4               .endif
000000r 4               	beq	@L
000000r 4               	jsr	nsd_sequence
000000r 4               @L:
000000r 4               .endif
000000r 4               ;---------------------------------------
000000r 4               
000000r 4               	lda	__Sequence_ptr + 1 + nsd::TR_SE_Pluse2
000000r 4               	ora	__Sequence_ptr + 1 + nsd::TR_SE_Noise
000000r 4               .ifdef	SE
000000r 4               	ora	__Sequence_ptr + 1 + nsd::TR_SE_Pluse1
000000r 4               	ora	__Sequence_ptr + 1 + nsd::TR_SE_Tri
000000r 4               	ora	__Sequence_ptr + 1 + nsd::TR_SE_Dpcm
000000r 4               .endif
000000r 4               .ifdef	DPCMBank
000000r 4               	ora	__Sequence_ptr + nsd::TR_SE_Pluse2
000000r 4               	ora	__Sequence_ptr + nsd::TR_SE_Noise
000000r 4               .ifdef	SE
000000r 4               	ora	__Sequence_ptr + nsd::TR_SE_Pluse1
000000r 4               	ora	__Sequence_ptr + nsd::TR_SE_Tri
000000r 4               	ora	__Sequence_ptr + nsd::TR_SE_Dpcm
000000r 4               .endif
000000r 4               .endif
000000r 4               
000000r 4               	bne	SE_Exit
000000r 4               
000000r 4               ;-----------------------------------------------------------
000000r 4               ;
000000r 4               ;	ldx	#nsd::TR_SE_Pluse2
000000r 4               ;	lda	__Sequence_ptr + 1,x
000000r 4               ;.ifdef	DPCMBank
000000r 4               ;	ora	__Sequence_ptr,x
000000r 4               ;.endif
000000r 4               ;	beq	SE0
000000r 4               ;	jsr	nsd_sequence
000000r 4               ;	jsr	nsd_envelop
000000r 4               ;SE0:
000000r 4               ;	ldx	#nsd::TR_SE_Noise
000000r 4               ;	lda	__Sequence_ptr + 1,x
000000r 4               ;.ifdef	DPCMBank
000000r 4               ;	ora	__Sequence_ptr,x
000000r 4               ;.endif
000000r 4               ;	beq	SE1
000000r 4               ;	jsr	nsd_sequence
000000r 4               ;	jsr	nsd_envelop
000000r 4               ;	jmp	SE_Exit
000000r 4               ;SE1:
000000r 4               ;	ora	__Sequence_ptr + nsd::TR_SE_Pluse2 + 1
000000r 4               ;.ifdef	DPCMBank
000000r 4               ;	ora	__Sequence_ptr + nsd::TR_SE_Pluse2
000000r 4               ;.endif
000000r 4               ;	bne	SE_Exit
000000r 4               ;
000000r 4               ;-----------------------------------------------------------
000000r 4               
000000r 4               	;SE Disable
000000r 4               	lda	#nsd_flag::SE
000000r 4               	ora	__flag
000000r 4               	sta	__flag
000000r 4               SE_Exit:
000000r 4               
000000r 4               .endmacro
000000r 4               
000000r 3               
000000r 3               ;****************************************************************
000000r 3               ;*		Function of Library				*
000000r 3               ;****************************************************************
000000r 3               ;-----------------------------------------------
000000r 3               ;	void	__fastcall__	nsd_main(void);
000000r 3               ;-----------------------------------------------
000000r 3               ;	Summary :		main routine of this sound driver
000000r 3               ;	Arguments :		None
000000r 3               ;	Return :		None
000000r 3               ;	Modifies :		A X Y
000000r 3               ;	Useage :		Call by 60[Hz].  e.g. V-Blank
000000r 3               ;-----------------------------------------------
000000r 3               	.import		_nsd_main
000000r 3               	.import		_nsd_main_bgm
000000r 3               	.import		_nsd_main_se
000000r 3               
000000r 3               
000000r 3               ;-----------------------------------------------
000000r 3               ;	void	__fastcall__	nsd_init(void);
000000r 3               ;-----------------------------------------------
000000r 3               ;	Summary :		Initraize this sound driver.
000000r 3               ;	Arguments :		None
000000r 3               ;	Return :		None
000000r 3               ;	Modifies :		A X Y
000000r 3               ;	Useage :		Call when start up.
000000r 3               ;-----------------------------------------------
000000r 3               	.import		_nsd_init
000000r 3               
000000r 3               
000000r 3               ;-----------------------------------------------
000000r 3               ;	void	__fastcall__	nsd_set_dpcm(nsd_dpcm* dpcm);
000000r 3               ;-----------------------------------------------
000000r 3               ;	Summary :		Set the Delta PCM information.
000000r 3               ;	Arguments :	AX	Pointer of the Delta PCM information.
000000r 3               ;	Return :		None
000000r 3               ;	Modifies :		A X Y
000000r 3               ;-----------------------------------------------
000000r 3               	.import		_nsd_set_dpcm
000000r 3               
000000r 3               
000000r 3               ;-----------------------------------------------
000000r 3               ;	void	__fastcall__	nsd_play_bgm(void* ptr);
000000r 3               ;-----------------------------------------------
000000r 3               ;	Summary :		Play the BGM
000000r 3               ;	Arguments :	AX	Pointer of the BGM data.
000000r 3               ;	Return :		None
000000r 3               ;	Modifies :		A X Y
000000r 3               ;-----------------------------------------------
000000r 3               	.import		_nsd_play_bgm
000000r 3               
000000r 3               
000000r 3               ;-----------------------------------------------
000000r 3               ;	void	__fastcall__	nsd_stop_bgm(void);
000000r 3               ;-----------------------------------------------
000000r 3               ;	Summary :		Stop the BGM
000000r 3               ;	Arguments :		None
000000r 3               ;	Return :		None
000000r 3               ;	Modifies :		A X Y
000000r 3               ;-----------------------------------------------
000000r 3               	.import		_nsd_stop_bgm
000000r 3               
000000r 3               
000000r 3               ;-----------------------------------------------
000000r 3               ;	void	__fastcall__	nsd_pause_bgm(void);
000000r 3               ;-----------------------------------------------
000000r 3               ;	Summary :		Pause the BGM
000000r 3               ;	Arguments :		None
000000r 3               ;	Return :		None
000000r 3               ;	Modifies :		A X Y
000000r 3               ;-----------------------------------------------
000000r 3               	.import		_nsd_pause_bgm
000000r 3               
000000r 3               
000000r 3               ;-----------------------------------------------
000000r 3               ;	void	__fastcall__	nsd_resume_bgm(void);
000000r 3               ;-----------------------------------------------
000000r 3               ;	Summary :		Resume the BGM
000000r 3               ;	Arguments :		None
000000r 3               ;	Return :		None
000000r 3               ;	Modifies :		A X Y
000000r 3               ;-----------------------------------------------
000000r 3               	.import		_nsd_resume_bgm
000000r 3               
000000r 3               
000000r 3               ;-----------------------------------------------
000000r 3               ;	void	__fastcall__	_nsd_save(void* buff);
000000r 3               ;-----------------------------------------------
000000r 3               ;	Summary :		Save state and pause
000000r 3               ;	Arguments :	AX	Pointer of Save buff
000000r 3               ;	Return :		None
000000r 3               ;	Modifies :		A X Y
000000r 3               ;-----------------------------------------------
000000r 3               	.import		_nsd_save
000000r 3               
000000r 3               
000000r 3               ;-----------------------------------------------
000000r 3               ;	void	__fastcall__	_nsd_load(void* buff);
000000r 3               ;-----------------------------------------------
000000r 3               ;	Summary :		Pause and Load state
000000r 3               ;	Arguments :	AX	Pointer of Save buff
000000r 3               ;	Return :		None
000000r 3               ;	Modifies :		A X Y
000000r 3               ;-----------------------------------------------
000000r 3               	.import		_nsd_load
000000r 3               
000000r 3               
000000r 3               ;-----------------------------------------------
000000r 3               ;	void	__fastcall__	nsd_play_se(void* ptr);
000000r 3               ;-----------------------------------------------
000000r 3               ;	Summary :		Play the SE
000000r 3               ;	Arguments :	AX	Pointer of the SE data.
000000r 3               ;	Return :		None
000000r 3               ;	Modifies :		A X Y
000000r 3               ;-----------------------------------------------
000000r 3               	.import		_nsd_play_se
000000r 3               
000000r 3               
000000r 3               ;-----------------------------------------------
000000r 3               ;	void	__fastcall__	nsd_stop_se(void);
000000r 3               ;-----------------------------------------------
000000r 3               ;	Summary :		Stop the SE
000000r 3               ;	Arguments :		None
000000r 3               ;	Return :		None
000000r 3               ;	Modifies :		A X Y
000000r 3               ;-----------------------------------------------
000000r 3               	.import		_nsd_stop_se
000000r 3               
000000r 3               
000000r 3               
000000r 3               ;-----------------------------------------------
000000r 3               ;	Work area of nsd.lib
000000r 3               ;-----------------------------------------------
000000r 3               	.importzp	nsd_work_zp
000000r 3               	.import		nsd_work
000000r 3               
000000r 3               
000000r 3               
000000r 3               
000000r 2               
000000r 2               	.include	"struct.inc"
000000r 3               
000000r 3               ;************************************************************************
000000r 3               ;*		スプライト						*
000000r 3               ;************************************************************************
000000r 3               
000000r 3               ;１要素
000000r 3               .Struct	SPR_ONE
000000r 3               	pty	.byte
000000r 3               	num	.byte
000000r 3               	att	.byte
000000r 3               	ptx	.byte
000000r 3               .Endstruct
000000r 3               
000000r 3               ;全体
000000r 3               .Struct	SPR_TBL
000000r 3               	spr	.tag	SPR_ONE		64
000000r 3               .Endstruct
000000r 3               
000000r 3               
000000r 2               	.include	"macro.inc"
000000r 3               
000000r 3               
000000r 3               ;=======================================================================
000000r 3               ;	Macros
000000r 3               ;-----------------------------------------------------------------------
000000r 3               
000000r 3               .MACPACK generic
000000r 4               
000000r 4               ; add - Add without carry
000000r 4               .macro  add     Arg1, Arg2
000000r 4                       clc
000000r 4                       .if .paramcount = 2
000000r 4                               adc     Arg1, Arg2
000000r 4                       .else
000000r 4                               adc     Arg1
000000r 4                       .endif
000000r 4               .endmacro
000000r 4               
000000r 4               ; sub - subtract without borrow
000000r 4               .macro  sub     Arg1, Arg2
000000r 4                       sec
000000r 4                       .if .paramcount = 2
000000r 4                               sbc     Arg1, Arg2
000000r 4                       .else
000000r 4                               sbc     Arg1
000000r 4                       .endif
000000r 4               .endmacro
000000r 4               
000000r 4               ; bge - jump if unsigned greater or equal
000000r 4               .macro  bge     Arg
000000r 4                       bcs     Arg
000000r 4               .endmacro
000000r 4               
000000r 4               ; blt - Jump if unsigned less
000000r 4               .macro  blt     Arg
000000r 4                       bcc     Arg
000000r 4               .endmacro
000000r 4               
000000r 4               ; bgt - jump if unsigned greater
000000r 4               .macro  bgt     Arg
000000r 4                       .local  L
000000r 4                       beq     L
000000r 4                       bcs     Arg
000000r 4               L:
000000r 4               .endmacro
000000r 4               
000000r 4               ; ble - jump if unsigned less or equal
000000r 4               .macro  ble     Arg
000000r 4                       beq     Arg
000000r 4                       bcc     Arg
000000r 4               .endmacro
000000r 4               
000000r 4               ; bnz - jump if not zero
000000r 4               .macro  bnz     Arg
000000r 4                       bne     Arg
000000r 4               .endmacro
000000r 4               
000000r 4               ; bze - jump if zero
000000r 4               .macro  bze     Arg
000000r 4                       beq     Arg
000000r 4               .endmacro
000000r 4               
000000r 4               
000000r 3               .MACPACK longbranch
000000r 4               .macro  jeq     Target
000000r 4                       .if     .match(Target, 0)
000000r 4                       bne     *+5
000000r 4                       jmp     Target
000000r 4                       .elseif .def(Target) .and .const((*-2)-(Target)) .and ((*+2)-(Target) <= 127)
000000r 4                               beq     Target
000000r 4                       .else
000000r 4                               bne     *+5
000000r 4                               jmp     Target
000000r 4                       .endif
000000r 4               .endmacro
000000r 4               .macro  jne     Target
000000r 4                       .if     .match(Target, 0)
000000r 4                               beq     *+5
000000r 4                               jmp     Target
000000r 4                       .elseif .def(Target) .and .const((*-2)-(Target)) .and ((*+2)-(Target) <= 127)
000000r 4                               bne     Target
000000r 4                       .else
000000r 4                               beq     *+5
000000r 4                               jmp     Target
000000r 4                       .endif
000000r 4               .endmacro
000000r 4               .macro  jmi     Target
000000r 4                       .if     .match(Target, 0)
000000r 4                               bpl     *+5
000000r 4                               jmp     Target
000000r 4                       .elseif .def(Target) .and .const((*-2)-(Target)) .and ((*+2)-(Target) <= 127)
000000r 4                               bmi     Target
000000r 4                       .else
000000r 4                               bpl     *+5
000000r 4                               jmp     Target
000000r 4                       .endif
000000r 4               .endmacro
000000r 4               .macro  jpl     Target
000000r 4                       .if     .match(Target, 0)
000000r 4                               bmi     *+5
000000r 4                               jmp     Target
000000r 4                       .elseif .def(Target) .and .const((*-2)-(Target)) .and ((*+2)-(Target) <= 127)
000000r 4                               bpl     Target
000000r 4                       .else
000000r 4                               bmi     *+5
000000r 4                               jmp     Target
000000r 4                       .endif
000000r 4               .endmacro
000000r 4               .macro  jcs     Target
000000r 4                       .if     .match(Target, 0)
000000r 4                               bcc     *+5
000000r 4                               jmp     Target
000000r 4                       .elseif .def(Target) .and .const((*-2)-(Target)) .and ((*+2)-(Target) <= 127)
000000r 4                               bcs     Target
000000r 4                       .else
000000r 4                               bcc     *+5
000000r 4                               jmp     Target
000000r 4                       .endif
000000r 4               .endmacro
000000r 4               .macro  jcc     Target
000000r 4                       .if     .match(Target, 0)
000000r 4                               bcs     *+5
000000r 4                               jmp     Target
000000r 4                       .elseif .def(Target) .and .const((*-2)-(Target)) .and ((*+2)-(Target) <= 127)
000000r 4                               bcc     Target
000000r 4                       .else
000000r 4                               bcs     *+5
000000r 4                               jmp     Target
000000r 4                       .endif
000000r 4               .endmacro
000000r 4               .macro  jvs     Target
000000r 4                       .if     .match(Target, 0)
000000r 4                               bvc     *+5
000000r 4                               jmp     Target
000000r 4                       .elseif .def(Target) .and .const((*-2)-(Target)) .and ((*+2)-(Target) <= 127)
000000r 4                               bvs     Target
000000r 4                       .else
000000r 4                               bvc     *+5
000000r 4                               jmp     Target
000000r 4                       .endif
000000r 4               .endmacro
000000r 4               .macro  jvc     Target
000000r 4                       .if     .match(Target, 0)
000000r 4                               bvs     *+5
000000r 4                               jmp     Target
000000r 4                       .elseif .def(Target) .and .const((*-2)-(Target)) .and ((*+2)-(Target) <= 127)
000000r 4                               bvc     Target
000000r 4                       .else
000000r 4                               bvs     *+5
000000r 4                               jmp     Target
000000r 4                       .endif
000000r 4               .endmacro
000000r 4               
000000r 3               
000000r 3               
000000r 3               ;---------------------------------------
000000r 3               ;	ax <= arg(mem16/imm16)
000000r 3               ;---------------------------------------
000000r 3               .macro	LDAX	arg
000000r 3               	.if (.match (.left (1, {arg}), #))
000000r 3               		; immediate mode
000000r 3               		lda     #<(.right (.tcount ({arg})-1, {arg}))
000000r 3               		ldx     #>(.right (.tcount ({arg})-1, {arg}))
000000r 3               	.else
000000r 3               		; assume absolute or zero page
000000r 3               		lda     arg
000000r 3               		ldx     1+(arg)
000000r 3               	.endif
000000r 3               .endmacro
000000r 3               
000000r 3               
000000r 3               ;---------------------------------------
000000r 3               ;	arg(mem16) <= ax
000000r 3               ;---------------------------------------
000000r 3               .macro	STAX	arg
000000r 3               		; assume absolute or zero page
000000r 3               		sta     arg
000000r 3               		stx     1+(arg)
000000r 3               .endmacro
000000r 3               
000000r 3               
000000r 3               ;---------------------------------------
000000r 3               ;	ax <= ax + arg(mem16/imm16)
000000r 3               ;---------------------------------------
000000r 3               .macro	ADDW	arg
000000r 3               	clc
000000r 3               	.if (.match (.left (1, {arg}), #))
000000r 3               		; immediate mode
000000r 3               		adc     #<(.right (.tcount ({arg})-1, {arg}))
000000r 3               		pha
000000r 3               		txa
000000r 3               		adc     #>(.right (.tcount ({arg})-1, {arg}))
000000r 3               		tax
000000r 3               		pla
000000r 3               	.else
000000r 3               		; assume absolute or zero page
000000r 3               		adc     arg
000000r 3               		pha
000000r 3               		txa
000000r 3               		adc     1+(arg)
000000r 3               		tax
000000r 3               		pla
000000r 3               	.endif
000000r 3               .endmacro
000000r 3               
000000r 3               
000000r 3               ;---------------------------------------
000000r 3               ;	ax <= ax - arg(mem16/imm16)
000000r 3               ;---------------------------------------
000000r 3               .macro	SUBW	arg
000000r 3               	sec
000000r 3               	.if (.match (.left (1, {arg}), #))
000000r 3               		; immediate mode
000000r 3               		sbc     #<(.right (.tcount ({arg})-1, {arg}))
000000r 3               		pha
000000r 3               		txa
000000r 3               		sbc     #>(.right (.tcount ({arg})-1, {arg}))
000000r 3               		tax
000000r 3               		pla
000000r 3               	.else
000000r 3               		; assume absolute or zero page
000000r 3               		sbc     arg
000000r 3               		pha
000000r 3               		txa
000000r 3               		sbc     1+(arg)
000000r 3               		tax
000000r 3               		pla
000000r 3               	.endif
000000r 3               .endmacro
000000r 3               
000000r 3               
000000r 3               ;---------------------------------------
000000r 3               ;	arg(ax/mem16)++
000000r 3               ;---------------------------------------
000000r 3               .macro	INCW	arg
000000r 3               	.local	Skip
000000r 3               
000000r 3               	.if (.blank(arg)) .or (.xmatch ({arg}, ax))
000000r 3               		add	#1
000000r 3               		bne	Skip
000000r 3               		inx
000000r 3               	.else
000000r 3               		inc	arg
000000r 3               		bne	Skip
000000r 3               		inc	1+(arg)
000000r 3               	.endif
000000r 3               Skip:
000000r 3               .endmacro
000000r 3               
000000r 3               
000000r 3               ;---------------------------------------
000000r 3               ;	arg(ax/mem16)--
000000r 3               ;---------------------------------------
000000r 3               .macro	DECW	arg
000000r 3               	.local	Skip
000000r 3               	.if (.blank(arg)) .or (.match ({arg}, ax))
000000r 3               		sub	#1
000000r 3               		bcc	Skip
000000r 3               		dex
000000r 3               	.else
000000r 3               		pha
000000r 3               		lda	arg
000000r 3               		sub	#1
000000r 3               		sta	arg
000000r 3               		bcc	Skip
000000r 3               		dec	1+(arg)
000000r 3               		pla
000000r 3               	.endif
000000r 3               Skip:
000000r 3               .endmacro
000000r 3               
000000r 3               
000000r 3               ;---------------------------------------
000000r 3               ;	arg(a/mem8) <<= c
000000r 3               ;---------------------------------------
000000r 3               .macro	SHL	arg, c
000000r 3               	.repeat	c
000000r 3               		asl	arg
000000r 3               	.endrepeat
000000r 3               .endmacro
000000r 3               
000000r 3               .macro	shl	arg, c
000000r 3               	.repeat	c
000000r 3               		asl	arg
000000r 3               	.endrepeat
000000r 3               .endmacro
000000r 3               
000000r 3               
000000r 3               ;---------------------------------------
000000r 3               ;	arg(a/mem8) >>= c
000000r 3               ;---------------------------------------
000000r 3               .macro	SHR	arg, c
000000r 3               	.repeat	c
000000r 3               		lsr	arg
000000r 3               	.endrepeat
000000r 3               .endmacro
000000r 3               
000000r 3               .macro	shr	arg, c
000000r 3               	.repeat	c
000000r 3               		lsr	arg
000000r 3               	.endrepeat
000000r 3               .endmacro
000000r 3               
000000r 3               
000000r 3               ;---------------------------------------
000000r 3               ;	a >>= c	（算術シフト）	※アキュムレータ限定
000000r 3               ;---------------------------------------
000000r 3               .macro	SAR	arg, c
000000r 3               
000000r 3               	.if (.match ({arg}, a))
000000r 3               
000000r 3               		.repeat	c
000000r 3               			cmp	#$80
000000r 3               			ror	a
000000r 3               		.endrepeat
000000r 3               	.else
000000r 3               		pha
000000r 3               		lda	arg
000000r 3               		.repeat	c
000000r 3               			cmp	#$80
000000r 3               			ror	a
000000r 3               		.endrepeat
000000r 3               		sta	arg
000000r 3               		pla
000000r 3               	.endif
000000r 3               
000000r 3               .endmacro
000000r 3               
000000r 3               
000000r 3               ;---------------------------------------
000000r 3               ;	arg(mem16) <<= c
000000r 3               ;---------------------------------------
000000r 3               .macro	SHLW	arg, c
000000r 3               	.repeat	c
000000r 3               		asl	arg
000000r 3               		rol	1+(arg)
000000r 3               	.endrepeat
000000r 3               .endmacro
000000r 3               
000000r 3               
000000r 3               ;---------------------------------------
000000r 3               ;	arg(mem16) >>= c
000000r 3               ;---------------------------------------
000000r 3               .macro	SHRW	arg, c
000000r 3               	.repeat	c
000000r 3               		lsr	1+(arg)
000000r 3               		ror	arg
000000r 3               	.endrepeat
000000r 3               .endmacro
000000r 3               
000000r 3               
000000r 3               ;---------------------------------------
000000r 3               ;	arg(mem16) >>= c	（算術シフト）
000000r 3               ;---------------------------------------
000000r 3               .macro	SARW	arg, c
000000r 3               	pha
000000r 3               	lda	1+(arg)
000000r 3               	.repeat	c
000000r 3               		cmp	#$80
000000r 3               		ror	a
000000r 3               		ror	arg
000000r 3               	.endrepeat
000000r 3               	sta	1+(arg)
000000r 3               	pla
000000r 3               .endmacro
000000r 3               
000000r 3               
000000r 3               ;---------------------------------------
000000r 3               ;	ＢＧアドレス計算
000000r 3               ;---------------------------------------
000000r 3               ;	ptx	X 座標
000000r 3               ;	pty	Y 座標
000000r 3               ;	scn	スクリーン番号
000000r 3               ;---------------------------------------
000000r 3               .define	ADDR_BG(ptx,pty,scn)	$2000 + (ptx) + ((pty)*32) + ((scn)*$400)
000000r 3               
000000r 3               
000000r 3               ;---------------------------------------
000000r 3               ;	スプライトアドレス計算
000000r 3               ;---------------------------------------
000000r 3               ;	number	スプライト番号（0～63）
000000r 3               ;	member	アクセスするメンバー
000000r 3               ;		　ptx	Ｘ座標
000000r 3               ;		　pty	Ｙ座標
000000r 3               ;		　num	キャラクター
000000r 3               ;		　att	属性（パレットや反転など）
000000r 3               ;---------------------------------------
000000r 3               .define	ADDR_SPR(number,member)	_ppu_sprite_buff + ((number)*4) + SPR_ONE::member
000000r 3               
000000r 3               
000000r 3               ;---------------------------------------
000000r 3               ;	VBLANK 待ち
000000r 3               ;---------------------------------------
000000r 3               .macro	WAIT_VBLANK
000000r 3               	.local	Skip
000000r 3               Skip:	lda	PPU_STATUS
000000r 3               	bpl	Skip
000000r 3               .endmacro
000000r 3               
000000r 3               ;---------------------------------------
000000r 3               ;	NMI 割り込み待ち
000000r 3               ;---------------------------------------
000000r 3               .macro	WAIT_NMI
000000r 3               	.local	Skip
000000r 3               	lda	__cc
000000r 3               Skip:	cmp	__cc
000000r 3               	beq	Skip
000000r 3               .endmacro
000000r 3               
000000r 3               ;---------------------------------------
000000r 3               ;	ジャンプ
000000r 3               ;---------------------------------------
000000r 3               .macro	JMP_AX
000000r 3               	STAX	_JMP_Address
000000r 3               	jmp	(_JMP_Address)
000000r 3               .endmacro
000000r 3               
000000r 3               ;---------------------------------------
000000r 3               ;	コール
000000r 3               ;---------------------------------------
000000r 3               .macro	JSR_AX
000000r 3               	jsr	jsr_ax
000000r 3               .endmacro
000000r 3               
000000r 3               ;---------------------------------------
000000r 3               ;	バンク間コール
000000r 3               ;---------------------------------------
000000r 3               .macro	FARJSR	bank, adr
000000r 3               	LDAX	adr
000000r 3               	ldy	bank
000000r 3               	jsr	jsr_axy
000000r 3               .endmacro
000000r 3               
000000r 3               ;---------------------------------------
000000r 3               ;	画面表示
000000r 3               ;	※垂直同期を待つこと！！
000000r 3               ;---------------------------------------
000000r 3               .macro	DISP_SET
000000r 3               	sta	PPU_CTRL1
000000r 3               	sta	__Flag_2000
000000r 3               .endmacro
000000r 3               
000000r 3               .macro	DISP_SET1
000000r 3               	sta	PPU_CTRL1
000000r 3               	sta	__Flag_2000
000000r 3               .endmacro
000000r 3               
000000r 3               .macro	DISP_SET2
000000r 3               	sta	PPU_CTRL2
000000r 3               	sta	__Flag_2001
000000r 3               .endmacro
000000r 3               ;---------------------------------------
000000r 3               ;	画面表示
000000r 3               ;---------------------------------------
000000r 3               .macro	DISP_ON
000000r 3               	WAIT_VBLANK			;垂直同期まで待つ
000000r 3               	lda	#sysdef::PPU_Ctrl1_set	;割り込みは開始する。
000000r 3               	sta	PPU_CTRL1
000000r 3               	sta	__Flag_2000
000000r 3               	lda	#sysdef::PPU_Ctrl2_set	;MMC3 IRQの初期化のために、
000000r 3               	sta	__Flag_2001		;BG, Spr共に表示をonにする。
000000r 3               	sta	PPU_CTRL2		;
000000r 3               .endmacro
000000r 3               
000000r 3               ;---------------------------------------
000000r 3               ;	画面を消します。
000000r 3               ;	（消す前の状態は、維持）
000000r 3               ;---------------------------------------
000000r 3               .macro	DISP_OFF
000000r 3               	lda	#%00000000
000000r 3               	sta	PPU_CTRL1
000000r 3               	sta	PPU_CTRL2
000000r 3               	WAIT_VBLANK			;画面が消えるまで待つ
000000r 3               .endmacro
000000r 3               
000000r 3               ;---------------------------------------
000000r 3               ;	画面を元に戻します。
000000r 3               ;	（消す前の状態に、復帰）
000000r 3               ;---------------------------------------
000000r 3               .macro	DISP_RET
000000r 3               	WAIT_VBLANK			;垂直同期まで待つ
000000r 3               	lda	__Flag_2000
000000r 3               	sta	PPU_CTRL1
000000r 3               	lda	__Flag_2001
000000r 3               	sta	PPU_CTRL2
000000r 3               .endmacro
000000r 3               
000000r 3               ;---------------------------------------
000000r 3               ;	キー取得
000000r 3               ;---------------------------------------
000000r 3               ;●現在押されているキー
000000r 3               .macro	GET_PAD0
000000r 3               	lda	__PAD0
000000r 3               .endmacro
000000r 3               
000000r 3               .macro	GET_PAD1
000000r 3               	lda	__PAD1
000000r 3               .endmacro
000000r 3               
000000r 3               ;●離されたキー
000000r 3               .macro	GET_PAD0_REMOVE
000000r 3               	lda	__PAD0_REL
000000r 3               .endmacro
000000r 3               
000000r 3               .macro	GET_PAD1_REMOVE
000000r 3               	lda	__PAD1_REL
000000r 3               .endmacro
000000r 3               
000000r 3               ;●押されたキー
000000r 3               .macro	GET_PAD0_PRESS
000000r 3               	lda	__PAD0_TRG
000000r 3               .endmacro
000000r 3               
000000r 3               .macro	GET_PAD1_PRESS
000000r 3               	lda	__PAD1_TRG
000000r 3               .endmacro
000000r 3               
000000r 3               
000000r 2               	.include	"work.inc"
000000r 3               
000000r 3               
000000r 3               .ifndef	__NDK_WORK_INC__
000000r 3               
000000r 3               .define	__NDK_WORK_INC__
000000r 3               
000000r 3               	;Zeropage works
000000r 3               	.importzp	__r0
000000r 3               	.importzp	__r1
000000r 3               	.importzp	__r2
000000r 3               	.importzp	__r3
000000r 3               	.importzp	__r4
000000r 3               	.importzp	__r5
000000r 3               	.importzp	__r6
000000r 3               	.importzp	__r7
000000r 3               
000000r 3               	.importzp	__n0
000000r 3               	.importzp	__n1
000000r 3               	.importzp	__n2
000000r 3               	.importzp	__n3
000000r 3               
000000r 3               	.importzp	__i0
000000r 3               	.importzp	__i1
000000r 3               	.importzp	__i2
000000r 3               	.importzp	__i3
000000r 3               
000000r 3               	.importzp	__Flag_2000
000000r 3               	.importzp	__Flag_2001
000000r 3               
000000r 3               	.importzp	__cc
000000r 3               	.importzp	__ss
000000r 3               	.importzp	__mm
000000r 3               	.importzp	__hh
000000r 3               
000000r 3               	.importzp	__PAD0
000000r 3               	.importzp	__PAD1
000000r 3               	.importzp	__PAD0_OLD
000000r 3               	.importzp	__PAD1_OLD
000000r 3               	.importzp	__PAD0_REL
000000r 3               	.importzp	__PAD1_REL
000000r 3               	.importzp	__PAD0_TRG
000000r 3               	.importzp	__PAD1_TRG
000000r 3               
000000r 3               	;Non Zeropage works
000000r 3               	.import		_NMI_CallBack
000000r 3               	.import		_IRQ_CallBack
000000r 3               	.import		_JMP_Address
000000r 3               
000000r 3               	;Sprite
000000r 3               	.import		_ppu_sprite_buff
000000r 3               .endif
000000r 3               
000000r 2               
000000r 2               ;---------------------------------------
000000r 2               ;	システムプログラム中の定数を定義します。
000000r 2               ;---------------------------------------
000000r 2               
000000r 2               .scope	sysdef
000000r 2               
000000r 2               ;PPU
000000r 2               PPU_Ctrl1_set		= PPU_CTRL1_VBLANK | PPU_CTRL1_SPTBL
000000r 2               PPU_Ctrl2_set		= PPU_CTRL2_SPDISP | PPU_CTRL2_BGDISP | PPU_CTRL2_SPCLIP | PPU_CTRL2_BGCLIP
000000r 2               
000000r 2               .endscope
000000r 2               
000000r 2               
000000r 2               
000000r 2               
000000r 2               ;---------------------------------------
000000r 2               ;	ＩＯ
000000r 2               ;---------------------------------------
000000r 2               ; $2000 PPU Control Register 0
000000r 2               PPU_CTRL1_VBLANK	= $80
000000r 2               PPU_CTRL1_SLAVE		= $40
000000r 2               PPU_CTRL1_SP16		= $20
000000r 2               PPU_CTRL1_BGTBL		= $10
000000r 2               PPU_CTRL1_SPTBL		= $08
000000r 2               PPU_CTRL1_INC32		= $04
000000r 2               PPU_CTRL1_NAMETBL	= $03
000000r 2               
000000r 2               ; $2001 PPU Control Register 1
000000r 2               PPU_CTRL2_BGCOLOR	= $E0
000000r 2               PPU_CTRL2_SPDISP	= $10
000000r 2               PPU_CTRL2_BGDISP	= $08
000000r 2               PPU_CTRL2_SPCLIP	= $04
000000r 2               PPU_CTRL2_BGCLIP	= $02
000000r 2               PPU_CTRL2_COLORMODE	= $01
000000r 2               
000000r 2               PAD_RIGHT	= $01
000000r 2               PAD_LEFT	= $02
000000r 2               PAD_DOWN	= $04
000000r 2               PAD_UP		= $08
000000r 2               PAD_START	= $10
000000r 2               PAD_SELECT	= $20
000000r 2               PAD_B		= $40
000000r 2               PAD_A		= $80
000000r 2               
000000r 1               
000000r 1               
000000r 1               .segment	"LOWCODE"
000000r 1               ;===============================================================
000000r 1               ;			IRQ_main(void);
000000r 1               ;---------------------------------------------------------------
000000r 1               ;	Summary :		IRQ main routine
000000r 1               ;	Arguments :		None
000000r 1               ;	Return :		None
000000r 1               ;	Modifies :		None
000000r 1               ;	Useage :		Please write this address to interrupt vector
000000r 1               ;===============================================================
000000r 1               .proc	IRQ_main			;[7]
000000r 1               
000000r 1               ;---------------------------------------
000000r 1               ;register push
000000r 1               ;---------------------------------------
000000r 1  48           	pha				;[3]10
000001r 1  98           	tya				;[2]12
000002r 1  48           	pha				;[3]15
000003r 1  8A           	txa				;[2]17
000004r 1  48           	pha				;[3]20
000005r 1               
000005r 1               ;---------------------------------------
000005r 1               ;call the callback routine
000005r 1               ;---------------------------------------
000005r 1               
000005r 1               ;	lda	_IRQ_CallBack + 1	;[4]24
000005r 1               ;	beq	CallBack_Ret		;[2]26
000005r 1               ;	jsr	jmp_IRQ_CallBack	;[6]32
000005r 1               
000005r 1               CallBack_Ret:
000005r 1               
000005r 1               ;---------------------------------------
000005r 1               ;register pop
000005r 1               ;---------------------------------------
000005r 1  68           	pla
000006r 1  AA           	tax
000007r 1  68           	pla
000008r 1  A8           	tay
000009r 1  68           	pla
00000Ar 1               
00000Ar 1  40           	rti
00000Br 1               .endproc
00000Br 1               
00000Br 1               .proc	jmp_IRQ_CallBack
00000Br 1  6C rr rr     	jmp	(_IRQ_CallBack)		;[5]37 clock
00000Er 1               .endproc
00000Er 1               
